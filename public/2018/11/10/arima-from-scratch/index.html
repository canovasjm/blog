<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Hugo 0.49" />


<title>ARIMA from scratch - jmcanovas</title>
<meta property="og:title" content="ARIMA from scratch - jmcanovas">



  








<link href='//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css' rel='stylesheet' type='text/css' />



<link rel="stylesheet" href="/css/fonts.css" media="all">
<link rel="stylesheet" href="/css/main.css" media="all">



  </head>
  <body>
    <div class="wrapper">
      <header class="header">
        <nav class="nav">
  <a href="/" class="nav-logo">
    <img src="/images/%3cnil%3e"
         width=""
         height=""
         alt="">
  </a>

  <ul class="nav-links">
    
    <li><a href="/about/">About</a></li>
    
    <li><a href="/contact/">Contact</a></li>
    
    <li><a href="https://stats.stackexchange.com/users/218995/juan-manuel">Cross Validated</a></li>
    
    <li><a href="https://github.com/jmcanovas">GitHub</a></li>
    
    <li><a href="/portfolio/">Portfolio</a></li>
    
  </ul>
</nav>

      </header>


<main class="content" role="main">

  <article class="article">
    
    <span class="article-duration">10 min read</span>
    

    <h1 class="article-title">ARIMA from scratch</h1>

    
    <span class="article-date">2018/11/10</span>
    

    <div class="article-content">
      <p>Hi there! This post is a modification of the final project I did for my Time Series class and the idea is simple: fit an ARIMA model and make a forecast. To do so in R we can use <code>auto.arima()</code> from <strong>forecast</strong> package, or we can decide what model are we going to fit and why. We will choose the latter path :)</p>
<p>Here we are going to explore how the number of domestic air passengers in Argentina has evolved in the last years, fit a model to the data, and forecast the number of domestic passengers for the next twelve months.</p>
<p>We will start by loading all the libraries needed:</p>
<pre class="r"><code># Required libraries  
library(astsa)
library(dplyr)
library(ggplot2)
library(knitr)</code></pre>
<div id="the-data" class="section level2">
<h2>The data</h2>
<p>The data was taken from <strong>“Tablas de Movimientos y Pasajeros EANA 2014 - 2018”</strong>, a report from Empresa Argentina de Navegacion Aerea. It can be accessed via the following link: <a href="https://www.eana.com.ar/estadisticas#informes" class="uri">https://www.eana.com.ar/estadisticas#informes</a></p>
<p>The data set contains a lot of information about airline passengers and flights in Argentina for the period 2014 - 2018. We will concentrate in the number of domestic airline passengers for the 54 months between January 2014 and June 2018.</p>
<p>The data is presented as an xlsx file and it is displayed in a way that it is hard to import in R. Hence, before importing it, I pre-cleaned it using Microsoft Excel. You can access the pre-cleaned version here.</p>
<pre class="r"><code># Data import
# Import csv file
df &lt;- read.csv(&quot;C:/Users/Juan Manuel/Documents/STAT 498/Project/EANA/passengers_ts.csv&quot;, 
               header = TRUE)

# Remove year and month
dat &lt;- df %&gt;% 
  select(-c(year, month))

# Create time series object
dat &lt;- dat %&gt;% 
  ts(start = c(2014, 1), end = c(2018, 6), deltat = 1/12)</code></pre>
</div>
<div id="first-analysis-time-plot" class="section level2">
<h2>First analysis: time plot</h2>
<p>The first step in the analysis is to make a plot of the original data, where the number of domestic passengers is taken as the response variable and the time (months) as the explanatory variable. To do the plot we just use the function <code>plot.ts()</code></p>
<pre class="r"><code># Analysis: Time plot
# Original data time plot
plot.ts(dat[ , 1],
        ylab = &quot;thousand passengers&quot;,
        main = &quot;Domestic air passengers in Argentina 2014 - 2018&quot;)</code></pre>
<p><img src="/post/2018-11-10-arima-from-scratch_files/figure-html/unnamed-chunk-3-1.png" width="672" /></p>
<p>The time plot above is showing that the data presents an upward trend and the variability is not constant over time. Because of this two facts, we can claim that the weak stationarity conditions are not met and, additionally, it seems that there is a seasonal behaviour of the underlying process.</p>
<p>Before fitting a model we will need to do some work on this data: i) variance stabilization transformation and ii) trend removal.</p>
</div>
<div id="variance-stabilization-transformation" class="section level2">
<h2>Variance stabilization transformation</h2>
<p><em>Why do we want to stabilize the variance?</em>, you may be wondering. Well, the problem with non-constant variance (a.k.a <em>heteroscedasticity</em>) is that, as time grows, small percent changes becomes large absolute changes. And we don’t want that in our model.</p>
<p>So, in order to stabilize the variance, we took the natural logarithm of the original data and will store the transfomed data in <strong>log_dat</strong></p>
<pre class="r"><code># Log transformation
log_dat&lt;- log(dat[ , 1])
plot.ts(log_dat,
        ylab = &quot;log thousand passengers&quot;,
        main = &quot;Domestic air passengers in Argentina 2014 - 2018&quot;)</code></pre>
<p><img src="/post/2018-11-10-arima-from-scratch_files/figure-html/unnamed-chunk-4-1.png" width="672" /></p>
<p>This plot looks like very similar to the first, but the range of the dependent variable is considerably smaller (pay attention to the values on the y-axis).</p>
</div>
<div id="trend-removal" class="section level2">
<h2>Trend removal</h2>
<p>On the first time plot we observed an upward trend that can be removed by differencing the data. Besides the time plot, one can use the ACF of to determine if differencing is needed before fitting a model.<br />
In this section we will use the <code>acf2()</code> function from <strong>astsa</strong> package, which plots the ACF and PACF values for different lags.</p>
<p><em>Note: In the x-axis for the ACF and PACF plots below, the integer numbers represent years. In between two integers there are twelve marks in the x-axis, one for each month of the year.</em></p>
<pre class="r"><code># Correlation structure
log_acf &lt;- acf2(log_dat, 
                max.lag = 30, 
                main = &quot;log thousand passengers&quot;)</code></pre>
<p><img src="/post/2018-11-10-arima-from-scratch_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
<p>As we see in the ACF plot above, it presents a slow decay as the lag increases. This supports our initial hypothesis that difference is needed.</p>
<div id="non-seasonal-differentiation" class="section level3">
<h3>Non-seasonal differentiation</h3>
<p>Here we will difference the transformed data (<strong>log_dat</strong>) and repeat the ACF and PACF analysis using <code>acf2()</code>.</p>
<pre class="r"><code># Differentiation
dlog_dat &lt;- diff(log_dat, lag = 1)
dlog_acf &lt;- acf2(dlog_dat,
                  max.lag = 45,
                  main = &quot;(Non seasonal) differenced log thousand passengers&quot;)</code></pre>
<p><img src="/post/2018-11-10-arima-from-scratch_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
<p>Beautiful, isn’t it? Be careful though, non-seasonal differencing removes only one part of the correlation. In the ACF plot above we still observe seasonal correlation for <span class="math inline">\(12 * k\)</span> for <span class="math inline">\(k = 1, 2, \ldots\)</span>.</p>
<p>In plain English, this is telling us that the number of air passengers of a certain month is related to the number of passengers for the same month in previous years. That is, the number of passengers in January of 2018 is related to the number of passengers in January of 2017, and so on.</p>
<p>Since the ACF tails off for <span class="math inline">\(12 * k\)</span> for <span class="math inline">\(k = 1, 2, \ldots\)</span> and PACF cuts off after lag 1, a sesonal autoregressive component of order one is needed.</p>
<p>Additionally, the following time plot of the non-seasonal differenced log data also helps in the analysis: we observe how the peaks and valleys repeat every twelve months.</p>
<pre class="r"><code># Time plot of non seasonal differenced data
plot.ts(dlog_dat,
        ylab = &quot;log thousand passengers&quot;,
        main = &quot;(Non seasonal differenced) log thousand passengers&quot;)
abline(h = 0, lwd = 1.5)</code></pre>
<p><img src="/post/2018-11-10-arima-from-scratch_files/figure-html/unnamed-chunk-7-1.png" width="672" /></p>
</div>
<div id="seasonal-differentiation" class="section level3">
<h3>Seasonal differentiation</h3>
<p>Now we will remove the seasonal correlation. To do this we use again the function <code>diff()</code>. Note that this time <code>lag = 12</code>: we are telling R to difference observations that are 12 months apart. This will perform January 2018 - January 2017, February 2018 - February 2017, etc…</p>
<p>Once we took seasonal differentiation, the ACF values lie between the blue dashed lines; meaning that the autocorelation function is not significantly different from zero.</p>
<pre class="r"><code># Seasonal and non seasonal differenced log data - ACF/PACF
ddlog_dat &lt;- diff(dlog_dat, lag = 12)
ddlog_acf &lt;- acf2(ddlog_dat,
                   max.lag = 35,
                   main = &quot;(Seasonal and non seasonal) differenced log thousand passengers&quot;)</code></pre>
<p><img src="/post/2018-11-10-arima-from-scratch_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
</div>
</div>
<div id="stationary-data" class="section level2">
<h2>Stationary data</h2>
<p>Finally, we make a time plot of the transformed and differenced data and it shows that now the process seems to be stationary:</p>
<pre class="r"><code># Seasonal and non seasonal differenced log data - Time plot
plot.ts(ddlog_dat,
        type = &quot;l&quot;,
        ylab = &quot;log thousand passengers&quot;,
        main = &quot;(Seasonal and non seasonal) differenced log thousand passengers&quot;)
abline(h = 0, lwd = 1.5)</code></pre>
<p><img src="/post/2018-11-10-arima-from-scratch_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
<hr />
</div>
<div id="model-fitting-and-cross-validation" class="section level2">
<h2>Model fitting and cross-validation</h2>
<p>Now that we have analyzed our data, and decided which transformations we are going to apply, we are going to select the model with cross-validation (CV). However, the cross validation procedure that we are going to apply with time series data is a little bit different to what we usually do with independent data.<br />
If you want to read about CV for time series I recommend <a href="https://stats.stackexchange.com/a/326247/218995">here</a>, <a href="https://robjhyndman.com/publications/cv-time-series/">here</a>, and <a href="https://robjhyndman.com/hyndsight/tscv/">here</a></p>
<p><em>Why do we need cross-validation?</em>. The answer is that we don’t want to test our models with the same data used to train them; that would be an over optimistic scenario. Instead, we want to test our model on unseen data.</p>
<p>Starting with 36 of our 54 months we are going to:</p>
<ol style="list-style-type: decimal">
<li>Fit a model on train data (blue dots),</li>
<li>Make a prediction for the test set (red dot),</li>
<li>Compute the error and square it,</li>
<li>Increase training data by one and repeat the process.</li>
</ol>
<p>Finally, we are going to average all the squared errors getting what is known as <em>Mean Squareed Error (MSE)</em>. A graphic representation of this process is shown in Rob J Hyndman’s blog post and he also provides the code to make it <a href="https://gist.github.com/robjhyndman/9fa152c585442bb076eb42a30a020091">here</a></p>
<p><img src="/post/2018-11-10-arima-from-scratch_files/figure-html/unnamed-chunk-10-1.png" width="672" /></p>
<p>Using the analysis of the previous sections, here we will fit two models to the log transformed data using the function <code>sarima()</code> from package <strong>astsa</strong>. This function is a wraper of <code>arima()</code>, but it returns an object called <strong>ttable</strong> that has the results of t-tests performed on each of the coefficients. The ttable is also printed in the summary of the model.</p>
<p>The objective of fitting two models is to identify whether or not a moving average component is needed. This is not really clear in the ACF/PACF and time plots analysis we made before, so we will fit one model with q = 1 and one with q = 0 and then compare AIC and BIC values.</p>
<p>The models we are going to fit are:</p>
<p><strong>model_1</strong>: ARIMA(p = 1, d = 1, q = 1, P = 1, D = 1, Q = 0, S = 12)<br />
<strong>model_2</strong>: ARIMA(p = 1, d = 1, q = 0, P = 1, D = 1, Q = 0, S = 12)</p>
<div id="model-1" class="section level3">
<h3>8.1) Model 1</h3>
<p>Using <code>sarima()</code> from astsa package:</p>
<pre class="r"><code># model_1 fitting
model_1 &lt;- sarima(train[-1], 
                  p = 1, d = 1, q = 1, 
                  P = 1, D = 1, Q = 0, S = 12, 
                  details = FALSE)
model_1</code></pre>
<p>Alternatively, we could fit the model using <code>arima()</code> from stats package, but then we would have to separately test the coefficients. Here is how to fit the model using <code>arima()</code>:</p>
<pre class="r"><code># model_1 fitting
m1 &lt;- arima(train[-1], 
            order = c(1, 1, 1), 
            seasonal = list(order = c(1, 1, 0), period = 12))
m1</code></pre>
</div>
<div id="model-2" class="section level3">
<h3>8.2) Model 2</h3>
<p>Now we fit model 2 using <code>sarima()</code>:</p>
<pre class="r"><code># model_2 fitting
model_2 &lt;- sarima(train[-1], 
                  p = 1, d = 1, q = 0, 
                  P = 1, D = 1, Q = 0, S = 12,
                  details = FALSE)
model_2</code></pre>
<p>Using <code>arima()</code>:</p>
<pre class="r"><code># model_2 fitting
m2 &lt;- arima(train[-1], 
            order = c(1, 1, 1), 
            seasonal = list(order = c(1, 1, 1), period = 12))
m2</code></pre>
</div>
<div id="model-selection" class="section level3">
<h3>8.3) Model selection</h3>
<p>From the tables above, we can see that the estimates of the coefficients for model 1 are all significantly different from zero; while this is not the case for model 2. In the latter, the p-value for the non seasonal autoregressive coefficient estimate is 0.59 meaning that we fail to reject the null the hypothesis that the coefficient’s estimate is equal to zero.</p>
<p>Additionally, AICc and BIC values are smaller for model 1, which leads us to prefer model 1 over model 2. There is one step left to conclude if the model is adequate or not: residual analysis. For this analysis I used the following plots:</p>
<pre class="r"><code># Residual plot for model_1
plot.ts(model_1$fit$residuals,
        ylab = &quot;log thousand passengers&quot;,
        main = &quot;Model 1 residuals&quot;)
abline(h = 0, lwd = 1.5)</code></pre>
<p>In the time plot of the residuals for model 1, they seem to be independent. Furthermore, the ACF/PACF values are not significantly different from zero; except for the PACF values corresponding to lag three and lag twelve. This result suggests the possibility that there is still some slight seasonal regularity in the residuals, but the addition of another seasonal autoregressive component does not improve the results.</p>
<p>To wrap up, selected model is model 1:</p>
<pre class="r"><code># Coefficients estimates
m1$coef

# Coefficients&#39; standard error
sqrt(diag(m1$var.coef))
sqrt(diag(model_1$fit$var.coef))</code></pre>
</div>
</div>
<div id="forecast" class="section level2">
<h2>9) Forecast</h2>
<p>For the forescast we can use <code>sarima.for()</code> from package astsa, but it automatically prints a plot of the forecasted values.<br />
I wanted to show you how to do the plots instead, so we are going to use the <code>predict()</code> function to get the forecast. However, the <strong>model_1</strong> object we fitted with <code>sarima()</code> function is not going to work here, so in order to use the <code>predict()</code> function we are going to use the <strong>m1</strong> model that we created with <code>arima()</code> function.</p>
<p>Note that the arguments of <code>predict()</code> are the name of the model and the number of time periods ahead. Since our data is monthly, we set n.ahead = 12.</p>
<pre class="r"><code># Forecast
m1_for &lt;- predict(m1, n.ahead = 12)
m2_for &lt;- predict(m2, n.ahead = 12)</code></pre>
<pre class="r"><code>yhat1 &lt;- exp(m1_for$pred)
yhat2 &lt;- exp(m2_for$pred)</code></pre>
<pre class="r"><code>m1_MSEP &lt;- mean((yhat1 - dat[43:54, 3])^2) 
m1_MSEP


m2_MSEP &lt;- mean((yhat2 - dat[43:54, 3])^2) 
m2_MSEP</code></pre>
</div>
<div id="more-plots-original-data-forecast" class="section level2">
<h2>10) More plots: Original data + forecast</h2>
<p>Finally, we are going to plot the original data and our forecast. To do so we start by creating a data frame with the values of interest.</p>
<pre class="r"><code># Final values
f_values &lt;- data.frame(&quot;Year&quot; = c(rep(2017, 6), rep(2018, 6)), 
                       &quot;Month&quot; = c(&quot;Jul&quot;, &quot;Aug&quot;, &quot;Sep&quot;, &quot;Oct&quot;, &quot;Nov&quot;, &quot;Dec&quot;,
                                   &quot;Jan&quot;, &quot;Feb&quot;, &quot;Mar&quot;, &quot;Apr&quot;, &quot;May&quot;, &quot;Jun&quot;),
                       &quot;Forecasted_Passengers&quot; = round(exp(m1_for$pred), 2),
                       &quot;Actual_Passengers&quot; = df[43:54, 3])


################################################################################
# Forecast plots 
################################################################################
# Past data
t &lt;- 1:54

plot(t, rep(NA, 54), 
     ylim = c(600, 1400),
     xlab = &quot;t [months]&quot;,
     ylab = &quot;thousand passengers&quot;,
     main = &quot;Train, test, and forecaseted passengers&quot;)

grid(lty = 1, col = gray(0.9))

lines(t, 
      c(df[1:42, 3], rep(NA, 12)),
      lwd = 2,
      type = &quot;l&quot;)

# Add forecasts
lines(t, c(rep(NA, 41), df[42, 3], f_values$Forecasted_Passengers),
      lwd = 2,
      col = &quot;blue&quot;)

# Add actual
lines(t, c(rep(NA, 41), df[42, 3], f_values$Actual_Passengers), 
      lwd = 2,
      col = &quot;red&quot;)

# Legend
legend(x = &quot;bottomright&quot;, 
       legend = c(&quot;Train&quot;, &quot;Forecast&quot;, &quot;Test&quot;),
       col = c(1, 4, 2), 
       pch = c(16, 16, 16),
       bty = &quot;n&quot;)</code></pre>
</div>

    </div>
  </article>

  
<section id="comments">
  <div id="disqus_thread"></div>
  <script>
  var disqus_config = function () {
  
  };
  (function() {
    var inIFrame = function() {
      var iframe = true;
      try { iframe = window.self !== window.top; } catch (e) {}
      return iframe;
    };
    if (inIFrame()) return;
    var d = document, s = d.createElement('script');
    s.src = '//jmcanovas.disqus.com/embed.js'; s.async = true;
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</section>



</main>

      <footer class="footer">
        <ul class="footer-links">
          <li>
            <a href="/index.xml" type="application/rss+xml" target="_blank">RSS feed</a>
          </li>
          <li>
            <a href="https://gohugo.io/" class="footer-links-kudos">Made with <img src="/images/hugo-logo.png" alt="Img link to Hugo website" width="22" height="22"></a>
          </li>
        </ul>
      </footer>

    </div>
    



<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>



<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/r.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
<script>hljs.configure({languages: []}); hljs.initHighlightingOnLoad();</script>



    
<script src="/js/math-code.js"></script>
<script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>


    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-121816467-2', 'auto');
	
	ga('send', 'pageview');
}
</script>

  </body>
</html>

